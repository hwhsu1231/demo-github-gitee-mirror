# Distributed under the OSI-approved BSD 3-Clause License.
# See accompanying file LICENSE.txt for details.

name: get-crowdin-language-list

description: Get the Crowdin Language List

inputs:
  language:
    required: true    # [required]
    description: The language to fetch from the list, or 'all' to get all languages.
  languages-file:
    required: false
    description: The filename of the languages.json.
    default: 'languages.json'
  working-directory:
    required: false
    description: The directory from which to run commands or locate files.
    default: ${{ github.workspace }}

outputs:
  CROWDIN_LANGUAGE_LIST:
    value: ${{ steps.gcll.outputs.CROWDIN_LANGUAGE_LIST }}
    description: A comma-separated list of Crowdin languages.

runs:
  using: composite
  steps:
    - name: Get the Crowdin Language List
      id: gcll
      shell: bash
      run: |
        # Remove the possible '\r' in array generated by jq. (for Windows Bash)
        # See https://github.com/jqlang/jq/issues/92#issuecomment-350754078
        # Starting from version 1.7 of jq, we can pass --binary/-b argument to do so.
        # See https://github.com/jqlang/jq/releases/tag/jq-1.7
        if [[ "${{ inputs.language }}" == "all" ]]; then
          CROWDIN_LANGUAGES=($(jq -r 'values[].crowdin' languages.json | tr -d '\r'))
        else
          CROWDIN_LANGUAGES=($(jq -r --arg key "${{ inputs.language }}" 'values[$key].crowdin' languages.json | tr -d '\r'))
        fi
        echo "CROWDIN_LANGUAGES: ${CROWDIN_LANGUAGES[@]}"

        CROWDIN_LANGUAGE_LIST=""
        for CROWDIN_LANGUAGE in "${CROWDIN_LANGUAGES[@]}"; do
          echo "CROWDIN_LANGUAGE: ${CROWDIN_LANGUAGE}"
          if [[ -z ${CROWDIN_LANGUAGE_LIST} ]]; then
            CROWDIN_LANGUAGE_LIST="${CROWDIN_LANGUAGE}"
          else
            CROWDIN_LANGUAGE_LIST="${CROWDIN_LANGUAGE_LIST},${CROWDIN_LANGUAGE}"
          fi
        done

        echo "CROWDIN_LANGUAGE_LIST=${CROWDIN_LANGUAGE_LIST}" >> ${GITHUB_OUTPUT}
        echo "CROWDIN_LANGUAGE_LIST:"
        echo "${CROWDIN_LANGUAGE_LIST}"
